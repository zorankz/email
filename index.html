<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCUMAIL Pro - Interfaz Blanca</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Updated variables for the white theme */
            --primary-gradient: linear-gradient(135deg, #007bff 0%, #00c6ff 100%); /* A pleasant blue gradient */
            --secondary-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%); /* A pleasant green gradient */
            --dark-bg: #ffffff; /* Main background is white */
            --darker-bg: #f8f9fa; /* Slightly darker background for particles */
            --card-bg: #ffffff; /* Card background is white */
            --card-hover: #e9ecef; /* Light grey on hover */
            --accent-color: #007bff; /* Primary accent color (blue) */
            --accent-light: #00c6ff; /* Lighter accent color */
            --text-primary: #212529; /* Dark text for readability */
            --text-secondary: #6c757d; /* Grey text for secondary info */
            --success-color: #28a745; /* Green */
            --warning-color: #ffc107; /* Yellow */
            --danger-color: #dc3545; /* Red */
            --info-color: #17a2b8; /* Cyan */
            --transition-speed: 0.5s;
            --glass-effect: rgba(0, 0, 0, 0.05); /* Light glass effect */
            --glass-border: 1px solid rgba(0, 0, 0, 0.1); /* Light border */
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); /* Light shadow */
        }

        /* Optional: Define a dark theme if you want a toggle later */
        .dark-theme {
            --primary-gradient: linear-gradient(135deg, #6e45e2 0%, #88d3ce 100%);
            --secondary-gradient: linear-gradient(135deg, #ff7b25 0%, #ffcc00 100%);
            --dark-bg: #0f0f1a;
            --darker-bg: #0a0a12;
            --card-bg: #1a1a2e;
            --card-hover: #24243e;
            --accent-color: #6e45e2;
            --accent-light: #88d3ce;
            --text-primary: #f0f0f0;
            --text-secondary: #b8b8d1;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --glass-effect: rgba(255, 255, 255, 0.05);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Efecto de part√≠culas de fondo */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: var(--darker-bg);
        }

        /* Layout principal */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Sidebar futurista */
        .sidebar {
            width: 90px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.7); /* White with transparency */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: var(--glass-border);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: var(--glass-shadow);
            position: fixed;
            left: 0;
            top: 0;
        }

        .dark-theme .sidebar {
             background: rgba(26, 26, 46, 0.7); /* Dark with transparency */
        }


        .sidebar.expanded {
            width: 280px;
            align-items: flex-start;
            padding: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            width: 100%;
            justify-content: center;
            position: relative;
        }

        .sidebar.expanded .logo-container {
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-icon {
            font-size: 28px;
            background: var(--primary-gradient); /* Use primary gradient */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 0;
            transition: all var(--transition-speed);
        }

        .sidebar.expanded .logo-icon {
            margin-right: 15px;
        }

        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            font-size: 20px;
            opacity: 0;
            transition: opacity var(--transition-speed);
            background: var(--primary-gradient); /* Use primary gradient */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar.expanded .logo-text {
            opacity: 1;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: var(--text-secondary); /* Use secondary text color */
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0;
            position: absolute;
            right: -15px;
            background: var(--card-bg); /* Use card background */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Light shadow */
        }

         .dark-theme .toggle-sidebar {
             background: var(--darker-bg);
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
         }


        .sidebar:hover .toggle-sidebar {
            opacity: 1;
        }

        .sidebar.expanded .toggle-sidebar {
            transform: rotate(180deg);
        }

        .compose-btn {
            background: var(--primary-gradient); /* Use primary gradient */
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px;
            margin: 0 0 30px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4); /* Adjusted shadow color */
            width: 50px;
            height: 50px;
            position: relative;
            overflow: hidden;
        }

        .dark-theme .compose-btn {
             box-shadow: 0 4px 15px rgba(110, 69, 226, 0.4);
        }

        .sidebar.expanded .compose-btn {
            width: 100%;
            padding: 15px 25px;
            justify-content: flex-start;
        }

        .compose-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .compose-btn:hover::before {
            left: 100%;
        }

        .compose-icon {
            font-size: 18px;
        }

        .compose-text {
            display: none;
            margin-left: 10px;
            font-size: 14px;
        }

        .sidebar.expanded .compose-text {
            display: inline;
        }

        .menu {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar.expanded .menu {
            align-items: flex-start;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 12px;
            margin-bottom: 5px;
            width: 50px;
            height: 50px;
            justify-content: center;
            position: relative;
            color: var(--text-secondary);
        }

        .sidebar.expanded .menu-item {
            width: 100%;
            justify-content: flex-start;
        }

        .menu-item:hover {
            background: var(--glass-effect); /* Use light glass effect */
            color: var(--text-primary);
        }

        .menu-item.active {
            background: rgba(0, 123, 255, 0.15); /* Adjusted active background color */
            color: var(--accent-color);
        }

        .dark-theme .menu-item.active {
            background: rgba(110, 69, 226, 0.2);
        }


        .menu-item.active::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 3px;
            background: var(--accent-color); /* Use accent color */
            border-radius: 0 3px 3px 0;
        }

        .sidebar.expanded .menu-item.active::after {
            height: 30px;
        }

        .menu-icon {
            font-size: 20px;
            transition: all var(--transition-speed);
        }

        .menu-text {
            display: none;
            margin-left: 15px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: opacity var(--transition-speed);
        }

        .sidebar.expanded .menu-text {
            display: block;
            opacity: 1;
        }

        .menu-badge {
            display: none;
            margin-left: auto;
            background: var(--danger-color); /* Use danger color */
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .sidebar.expanded .menu-badge {
            display: block;
        }

        /* Submenu styles */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-left: 20px;
            width: calc(100% - 20px);
        }

        .sidebar.expanded .menu-item.has-submenu.active + .submenu {
            max-height: 500px;
        }

        .submenu-item {
            padding: 10px 15px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .submenu-item:hover {
            background: var(--glass-effect); /* Use light glass effect */
            color: var(--text-primary);
        }

        .submenu-item.active {
            color: var(--accent-color); /* Use accent color */
        }

        .submenu-item .menu-icon {
            font-size: 16px;
            margin-right: 10px;
        }

        .menu-item.has-submenu::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.3s;
            opacity: 0;
        }

        .sidebar.expanded .menu-item.has-submenu::after {
            opacity: 1;
        }

        .sidebar.expanded .menu-item.has-submenu.active::after {
            transform: translateY(-50%) rotate(180deg);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 90px;
            transition: margin-left var(--transition-speed);
            min-height: 100vh;
        }

        .sidebar.expanded + .main-content {
            margin-left: 280px;
        }

        /* Topbar hologr√°fico */
        .topbar {
            display: flex;
            align-items: center;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.7); /* White with transparency */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: var(--glass-border);
            z-index: 10;
            position: sticky;
            top: 0;
            box-shadow: var(--glass-shadow);
        }

        .dark-theme .topbar {
             background: rgba(26, 26, 46, 0.7);
        }


        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 30px;
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 12px 20px 12px 50px;
            border-radius: 30px;
            border: none;
            background: rgba(0, 0, 0, 0.05); /* Light background */
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .dark-theme .search-bar {
             background: rgba(255, 255, 255, 0.05);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--accent-color); /* Use accent color */
            background: rgba(0, 123, 255, 0.1); /* Adjusted focus background color */
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); /* Adjusted focus shadow */
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .user-actions {
            display: flex;
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            margin-left: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .action-btn:hover {
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .action-btn.notification::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 8px;
            height: 8px;
            background: var(--danger-color); /* Use danger color */
            border-radius: 50%;
            border: 2px solid var(--card-bg); /* Use card background */
        }


        .user-profile {
            display: flex;
            align-items: center;
            margin-left: 20px;
            cursor: pointer;
            position: relative;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color); /* Use accent color */
            transition: all 0.3s;
        }

        .user-profile:hover .profile-img {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); /* Adjusted shadow color */
        }

        .profile-name {
            margin-left: 10px;
            font-weight: 500;
            display: none;
        }

        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--card-bg); /* Use card background */
            border-radius: 10px;
            box-shadow: var(--glass-shadow);
            width: 200px;
            overflow: hidden;
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 100;
            border: var(--glass-border); /* Use light glass border */
        }


        .profile-dropdown.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: rgba(0, 0, 0, 0.05); /* Light hover background */
            color: var(--text-primary);
            padding-left: 25px;
        }

        .dark-theme .dropdown-item:hover {
             background: rgba(255, 255, 255, 0.05);
        }

        .dropdown-icon {
            margin-right: 10px;
            font-size: 16px;
            color: var(--accent-color); /* Use accent color */
        }

        /* Email content */
        .email-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Email list estilizado */
        .email-list-container {
            width: 350px;
            border-right: var(--glass-border); /* Use light glass border */
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.5); /* White with transparency */
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
        }

        .dark-theme .email-list-container {
             background: rgba(26, 26, 46, 0.5);
        }

        .email-list-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: var(--glass-border); /* Use light glass border */
            background: rgba(255, 255, 255, 0.7); /* White with transparency */
            backdrop-filter: blur(5px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .dark-theme .email-list-header {
             background: rgba(26, 26, 46, 0.7);
        }

        .email-list-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .email-list-title i {
            margin-right: 10px;
            color: var(--accent-color); /* Use accent color */
        }

        .email-list-actions {
            display: flex;
        }

        .list-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            margin-left: 15px;
            cursor: pointer;
            transition: all 0.2s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .list-action-btn:hover {
            color: var(--text-primary);
            background: rgba(0, 0, 0, 0.05); /* Light hover background */
        }

        .dark-theme .list-action-btn:hover {
             background: rgba(255, 255, 255, 0.1);
        }

        /* Items de email con efecto 3D */
        .email-item {
            padding: 20px;
            margin: 0 10px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--card-bg); /* Use card background */
            border: var(--glass-border); /* Use light glass border */
            transform-style: preserve-3d;
            transform: perspective(500px) translateZ(0);
            overflow: hidden;
        }


        .email-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(0, 123, 255, 0.1), transparent); /* Adjusted gradient color */
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .email-item:hover {
            background: var(--card-hover); /* Use lighter hover background */
            transform: perspective(500px) translateZ(20px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Adjusted shadow color */
        }

        .email-item.unread {
            border-left: 3px solid var(--accent-color); /* Use accent color */
        }

        .email-item.selected {
            background: rgba(0, 123, 255, 0.1); /* Adjusted selected background color */
            border: 1px solid rgba(0, 123, 255, 0.2); /* Adjusted selected border color */
        }

        .dark-theme .email-item.selected {
             background: rgba(110, 69, 226, 0.15);
             border: 1px solid rgba(110, 69, 226, 0.3);
        }


        .email-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .email-sender {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .email-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .email-subject {
            font-size: 14px;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .email-preview {
            font-size: 13px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
        }

        .email-actions {
            position: absolute;
            right: 15px;
            top: 15px;
            display: none;
            background: var(--card-hover); /* Use lighter hover background */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Adjusted shadow */
            overflow: hidden;
            z-index: 5;
            border: var(--glass-border); /* Use light glass border */
        }

        .dark-theme .email-actions {
             background: var(--card-hover);
             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }


        .email-item:hover .email-actions {
            display: flex;
        }

        .email-action-btn {
            padding: 8px 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .email-action-btn:hover {
            background: rgba(0, 0, 0, 0.05); /* Light hover background */
            color: var(--text-primary);
        }

        .dark-theme .email-action-btn:hover {
             background: rgba(255, 255, 255, 0.1);
        }

        .email-action-btn.delete:hover {
            color: var(--danger-color); /* Use danger color */
        }

        /* Detalle de email con efecto de cristal */
        .email-detail-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.5); /* White with transparency */
            backdrop-filter: blur(5px);
            overflow: hidden;
            position: relative;
        }

        .dark-theme .email-detail-container {
             background: rgba(26, 26, 46, 0.5);
        }

        .email-detail-header {
            padding: 20px;
            border-bottom: var(--glass-border); /* Use light glass border */
            background: rgba(255, 255, 255, 0.7); /* White with transparency */
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .dark-theme .email-detail-header {
             background: rgba(26, 26, 46, 0.7);
        }

        .email-detail-subject {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-light)); /* Use accent gradient */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .email-detail-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sender-info {
            display: flex;
            align-items: center;
        }

        .sender-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            background: var(--secondary-gradient); /* Use secondary gradient */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3); /* Adjusted shadow color */
        }

        .dark-theme .sender-avatar {
             box-shadow: 0 5px 15px rgba(255, 123, 37, 0.3);
        }

        .sender-details {
            display: flex;
            flex-direction: column;
        }

        .sender-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .sender-email {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .email-detail-actions {
            display: flex;
        }

        .detail-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            margin-left: 15px;
            cursor: pointer;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .detail-action-btn:hover {
            background: rgba(0, 0, 0, 0.05); /* Light hover background */
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .dark-theme .detail-action-btn:hover {
             background: rgba(255, 255, 255, 0.1);
        }

        .detail-action-btn.delete:hover {
            color: var(--danger-color); /* Use danger color */
            background: rgba(220, 53, 69, 0.1); /* Adjusted hover background */
        }

        .email-detail-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 15px;
        }

        .email-detail-body p {
            margin-bottom: 15px;
        }

        .email-detail-body ul, .email-detail-body ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .email-detail-body li {
            margin-bottom: 8px;
        }

        .attachments {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1); /* Light border */
        }

        .dark-theme .attachments {
             border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .attachments h4 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .attachment-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05); /* Light background */
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dark-theme .attachment-item {
             background: rgba(255, 255, 255, 0.05);
        }

        .attachment-item:hover {
            background: rgba(0, 0, 0, 0.1); /* Lighter hover background */
            transform: translateX(5px);
        }

        .dark-theme .attachment-item:hover {
             background: rgba(255, 255, 255, 0.1);
        }

        .attachment-item i {
            margin-right: 10px;
            font-size: 20px;
            color: var(--accent-color); /* Use accent color */
        }

        .attachment-download {
            margin-left: auto;
            color: var(--text-secondary);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .attachment-item:hover .attachment-download {
            opacity: 1;
        }

        .email-detail-footer {
            padding: 20px;
            border-top: var(--glass-border); /* Use light glass border */
            display: flex;
            justify-content: flex-end;
            background: rgba(255, 255, 255, 0.7); /* White with transparency */
            position: sticky;
            bottom: 0;
        }

        .dark-theme .email-detail-footer {
             background: rgba(26, 26, 46, 0.7);
        }

        .reply-btn, .forward-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .reply-btn {
            background: var(--primary-gradient); /* Use primary gradient */
            color: white;
            border: none;
            margin-right: 15px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4); /* Adjusted shadow */
        }

        .dark-theme .reply-btn {
             box-shadow: 0 4px 15px rgba(110, 69, 226, 0.4);
        }

        .reply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6); /* Adjusted shadow */
        }

        .dark-theme .reply-btn:hover {
             box-shadow: 0 6px 20px rgba(110, 69, 226, 0.6);
        }

        .forward-btn {
            background: transparent;
            border: 1px solid var(--accent-color); /* Use accent color */
            color: var(--accent-color); /* Use accent color */
        }

        .forward-btn:hover {
            background: rgba(0, 123, 255, 0.1); /* Adjusted hover background */
            transform: translateY(-2px);
        }

        .action-icon {
            margin-right: 8px;
        }

        /* Modal de composici√≥n flotante */
        .compose-modal {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 600px;
            max-height: 80vh;
            background: var(--card-bg); /* Use card background */
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); /* Adjusted shadow */
            overflow: hidden;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border: var(--glass-border); /* Use light glass border */
        }

        .compose-modal.show {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }

        .compose-header {
            padding: 15px 20px;
            background: var(--primary-gradient); /* Use primary gradient */
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compose-title {
            font-weight: 500;
            font-size: 16px;
        }

        .compose-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .compose-close:hover {
            background: rgba(0, 0, 0, 0.2); /* Adjusted hover background */
        }

        .compose-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .compose-input {
            width: 100%;
            padding: 12px 0;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* Light border */
            margin-bottom: 15px;
            font-size: 14px;
            background: transparent;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .dark-theme .compose-input {
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .compose-input:focus {
            outline: none;
            border-bottom-color: var(--accent-color); /* Use accent color */
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); /* Adjusted shadow */
        }

        .compose-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1); /* Light border */
            border-radius: 8px;
            resize: none;
            font-size: 14px;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.05); /* Light background */
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .dark-theme .compose-textarea {
             border: 1px solid rgba(255, 255, 255, 0.1);
             background: rgba(255, 255, 255, 0.05);
        }

        .compose-textarea:focus {
            outline: none;
            border-color: var(--accent-color); /* Use accent color */
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); /* Adjusted shadow */
        }

        .compose-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: var(--glass-border); /* Use light glass border */
            background: rgba(255, 255, 255, 0.7); /* White with transparency */
        }

        .dark-theme .compose-footer {
             background: rgba(26, 26, 46, 0.7);
        }

        .compose-send {
            padding: 10px 30px;
            background: var(--primary-gradient); /* Use primary gradient */
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4); /* Adjusted shadow */
        }

        .dark-theme .compose-send {
             box-shadow: 0 4px 15px rgba(110, 69, 226, 0.4);
        }

        .compose-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6); /* Adjusted shadow */
        }

        .dark-theme .compose-send:hover {
             box-shadow: 0 6px 20px rgba(110, 69, 226, 0.6);
        }

        .compose-attachments {
            display: flex;
            align-items: center;
        }

        .attachment-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            margin-right: 15px;
            cursor: pointer;
            transition: all 0.2s;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .attachment-btn:hover {
            background: rgba(0, 0, 0, 0.05); /* Light hover background */
            color: var(--text-primary);
        }

        .dark-theme .attachment-btn:hover {
             background: rgba(255, 255, 255, 0.1);
        }

        /* Generic Modal Structure (for Settings, Notifications, etc.) */
        .generic-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Slightly lighter overlay */
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .generic-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .generic-modal-content {
            background: var(--card-bg); /* Use card background */
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); /* Adjusted shadow */
            position: relative;
            border: var(--glass-border); /* Use light glass border */
            display: flex;
            flex-direction: column;
        }

        .generic-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: var(--glass-border); /* Use light glass border */
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .generic-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-color); /* Use accent color */
        }

        .generic-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .generic-modal-close:hover {
            color: var(--text-primary);
        }

        .generic-modal-body {
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* Settings form styles */
        .settings-form {
            display: flex;
            flex-direction: column;
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-group-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .settings-group-title i {
            margin-right: 10px;
            color: var(--accent-color); /* Use accent color */
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* Light border */
        }

        .dark-theme .setting-item {
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-label {
            font-size: 14px;
            color: var(--text-primary);
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color); /* Use accent color */
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: var(--card-bg); /* Use card background */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* Adjusted shadow */
            z-index: 1000;
            border: var(--glass-border); /* Use light glass border */
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
            min-width: 150px;
        }

        .context-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .context-item:hover {
            background: rgba(0,0,0,0.05); /* Light hover background */
            color: var(--text-primary);
            padding-left: 25px;
        }

        .dark-theme .context-item:hover {
             background: rgba(255,255,255,0.05);
        }

        .context-item i {
            margin-right: 10px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .context-item.delete {
            color: var(--danger-color); /* Use danger color */
        }
        .context-item.delete:hover {
             background: rgba(220, 53, 69, 0.1); /* Adjusted hover background */
        }

        /* Effects and Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

         @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(20px); opacity: 0; }
         }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
         @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
         }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        .float {
            animation: float 4s ease-in-out infinite;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::after {
            content: '';
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .ripple-effect:active::after {
            transform: scale(0, 0);
            opacity: .3;
            transition: 0s;
        }

        /* Efecto de onda en los botones */
        .wave-btn {
            position: relative;
            overflow: hidden;
        }

        .wave-btn .wave {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }

        .wave-btn .wave.active {
            animation: ripple 0.6s ease-out;
        }

        /* Responsive design */
        /* Hide mobile-only toggle on desktop */
        .toggle-sidebar.desktop-only {
             display: flex; /* Show desktop toggle */
             opacity: 0; /* Hide by default, show on sidebar hover */
             position: absolute;
             right: -15px;
             background: var(--card-bg);
             width: 30px;
             height: 30px;
             border-radius: 50%;
             align-items: center;
             justify-content: center;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
             top: 50%;
             transform: translateY(-50%);
        }

        .dark-theme .toggle-sidebar.desktop-only {
             background: var(--darker-bg);
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }


        .sidebar:hover .toggle-sidebar.desktop-only {
            opacity: 1; /* Show on hover */
        }

        .toggle-sidebar.mobile-only {
            display: none; /* Hide mobile toggle on desktop */
        }


        @media (max-width: 1200px) {
            .email-list-container {
                width: 300px;
            }

            .compose-modal {
                width: 500px;
            }
        }

        @media (max-width: 992px) {
             /* Show mobile-only toggle on mobile */
            .toggle-sidebar.mobile-only {
                display: flex;
                margin-right: 15px;
                opacity: 1;
                position: static;
                width: auto;
                height: auto;
                background: none;
                box-shadow: none;
                border-radius: 0;
                transform: none; /* Remove transform */
                top: auto; /* Remove top positioning */
            }

             /* Hide desktop toggle on mobile */
            .toggle-sidebar.desktop-only {
                 display: none;
            }


            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
                width: 280px;
                padding: 20px;
                align-items: flex-start;
                position: fixed; /* Ensure sidebar is fixed on mobile */
                height: 100vh; /* Ensure sidebar takes full height */
            }

            .sidebar.show-mobile {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .email-list-container {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 100%;
                z-index: 900;
                transform: translateX(0); /* Email list is shown by default on mobile */
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                overflow-y: auto; /* Allow scrolling on email list */
            }

            .email-list-container.hide-mobile {
                transform: translateX(-100%); /* Hide email list when email detail is shown */
            }


            .email-detail-container {
                display: none; /* Hidden by default on mobile */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 950;
                overflow-y: auto;
            }

            .email-detail-container.show-mobile {
                display: flex; /* Show email detail when an email is selected */
            }

            .compose-modal {
                width: 90%;
                right: 5%;
                left: 5%;
                margin: auto;
            }

            .profile-name {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .search-container {
                margin: 0 15px;
            }

            .email-detail-body {
                padding: 20px;
            }

            .email-detail-subject {
                font-size: 18px;
            }

            .email-detail-actions {
                 display: flex;
                 flex-direction: column;
                 align-items: flex-end;
            }
             .detail-action-btn {
                 margin-left: 0;
                 margin-bottom: 10px;
             }
             .detail-action-btn:last-child {
                 margin-bottom: 0;
             }

            .compose-modal {
                max-height: 70vh;
            }
        }

        @media (max-width: 576px) {
            .topbar {
                padding: 15px;
            }

            .search-bar {
                padding-left: 40px;
            }

            .search-icon {
                left: 15px;
            }

            .action-btn {
                margin-left: 10px;
            }

            .email-item {
                padding: 15px;
            }

            .reply-btn, .forward-btn {
                padding: 10px 15px;
                font-size: 13px;
            }
             .email-detail-actions {
                 flex-direction: row;
                 align-items: center;
             }
             .detail-action-btn {
                 margin-left: 5px;
                 margin-bottom: 0;
             }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05); /* Light track */
            border-radius: 10px;
        }

        .dark-theme ::-webkit-scrollbar-track {
             background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color); /* Use accent color */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-light); /* Use lighter accent color */
        }
        .iframe-modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 3000;
}

.iframe-modal-box {
    background: var(--card-bg);
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 900px;
    position: relative;
    overflow: hidden;
    animation: fadeIn 0.4s ease;
}

.iframe-close-btn {
    position: absolute;
    top: 10px; right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-secondary);
    cursor: pointer;
}

    </style>
</head>
<body>
    <div id="particles-js"></div>

    <div class="app-container">
        <div class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <span class="logo-icon"><i class="fas fa-mail-bulk"></i></span>
                    <span class="logo-text">DOCUMAIL</span>
                </div>
                 <button class="toggle-sidebar desktop-only">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <button class="compose-btn ripple-effect">
                <span class="compose-icon"><i class="fas fa-plus"></i></span>
                <span class="compose-text">New Message</span>
            </button>

            <div class="menu">
                <div class="menu-item active" data-section="inbox">
                    <span class="menu-icon"><i class="fas fa-inbox"></i></span>
                    <span class="menu-text">Entrada</span>
                    <span class="menu-badge">12</span>
                </div>
                <div class="menu-item" data-section="sent">
                    <span class="menu-icon"><i class="fas fa-paper-plane"></i></span>
                    <span class="menu-text">Enviados</span>
                </div>
                <div class="menu-item" data-section="drafts">
                    <span class="menu-icon"><i class="fas fa-file-alt"></i></span>
                    <span class="menu-text">Borradores</span>
                    <span class="menu-badge">3</span>
                </div>
                <div class="menu-item" data-section="trash">
                    <span class="menu-icon"><i class="fas fa-trash"></i></span>
                    <span class="menu-text">Basura</span>
                </div>
                <div class="menu-item" data-section="spam">
                    <span class="menu-icon"><i class="fas fa-exclamation-circle"></i></span>
                    <span class="menu-text">Spam</span>
                    <span class="menu-badge">24</span>
                </div>
                <div class="menu-item" data-section="archive">
                    <span class="menu-icon"><i class="fas fa-box-archive"></i></span>
                    <span class="menu-text">Archivados</span>
                </div>                
              
            </div>
        </div>

        <div class="main-content">
            <div class="topbar">
                 <button class="toggle-sidebar mobile-only">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-bar" placeholder="Search emails...">
                </div>

                <div class="user-actions">
                 
                    <button class="action-btn" title="Settings" id="show-settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="user-profile">
                        <img src="https://cdn-icons-png.flaticon.com/512/3177/3177440.png" alt="Profile" class="profile-img">
                        <span class="profile-name">USUARIO</span>
                        <div class="profile-dropdown">
                          
                        
                         
                            <div class="dropdown-item" data-action="logout">
                                <i class="fas fa-sign-out-alt dropdown-icon"></i>
                                <span>Logout</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="email-content">

                <!-- LISTA DE CORREOS -->
                <div class="email-list-container show-mobile">
                  <div class="email-list-header">
                    <div class="email-list-title">
                      <i class="fas fa-inbox"></i> <span id="current-folder-title">Inbox</span>
                    </div>
                    <div class="email-list-actions">
                      <button class="list-action-btn" title="Refresh" data-action="refresh">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                      <button class="list-action-btn" title="More" data-action="more-list-actions">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                    </div>
                  </div>
              
                  <!-- LISTA REAL -->
                  <div class="email-list"></div>
                </div>
              
                <!-- DETALLE DEL CORREO -->
                <div class="email-detail-container" style="display: none;">
                  <div class="email-detail-header">
                    <h2 class="email-detail-subject">(Sin asunto)</h2>
                    <div class="email-detail-info">
                      <div class="sender-info">
                        <div class="sender-avatar">U</div>
                        <div class="sender-details">
                          <span class="sender-name">Usuario</span>
                          <span class="sender-email">usuario@correo.com</span>
                        </div>
                      </div>
                      <div class="email-detail-actions">
                        <button class="detail-action-btn delete" data-action="delete"><i class="fas fa-trash"></i></button>
                        <button class="detail-action-btn archive" data-action="archive"><i class="fas fa-archive"></i></button>
                      </div>
                    </div>
                  </div>
              
                  <div class="email-detail-body">
                    <p>Selecciona un correo para verlo.</p>
                  </div>
                </div>
              
              </div>
              

    <div class="compose-modal">
        <div class="compose-header">
            <div class="compose-title">New Message</div>
            <button class="compose-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="compose-body">
            <input type="text" class="compose-input" id="compose-to" placeholder="To">
            <input type="text" class="compose-input" id="compose-cc" placeholder="Cc">
            <input type="text" class="compose-input" id="compose-subject" placeholder="Subject">
            <textarea class="compose-textarea" id="compose-body" placeholder="Write your message here..."></textarea>
        </div>
        <div class="compose-footer">
            <div class="compose-attachments">
      
            </div>
            <button class="compose-send wave-btn" data-action="send-email">Send</button>
        </div>
    </div>

     <div class="generic-modal" id="settings-modal">
        <div class="generic-modal-content">
            <div class="generic-modal-header">
                <div class="generic-modal-title">Settings</div>
                <button class="generic-modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="generic-modal-body">
                <form class="settings-form">
              

                    <div class="settings-group">
                        <div class="settings-group-title">
                            <i class="fas fa-bell"></i> Notifications
                        </div>
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Email Notifications</div>
                                <div class="setting-description">Receive notifications for new emails</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Desktop Alerts</div>
                                <div class="setting-description">Show desktop notifications</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                   
                      
                    </div>

                   
                    </div>
                </form>
            </div>
        </div>
    </div>

     <div class="generic-modal" id="notifications-modal">
        <div class="generic-modal-content">
            <div class="generic-modal-header">
                <div class="generic-modal-title">Notifications</div>
                <button class="generic-modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="generic-modal-body">
                <div class="notification-item" style="display: flex; align-items: flex-start; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div class="notification-icon" style="background: rgba(110, 69, 226, 0.1); color: var(--accent-color); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div>
                        <div class="notification-title" style="font-weight: 600; margin-bottom: 3px;">New email from Sarah Johnson</div>
                        <div class="notification-message" style="font-size: 13px; color: var(--text-secondary);">Project Update: Q3 Marketing Strategy</div>
                        <div class="notification-time" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">10:30 AM</div>
                    </div>
                </div>

                <div class="notification-item" style="display: flex; align-items: flex-start; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div class="notification-icon" style="background: rgba(255, 123, 37, 0.1); color: #ff7b25; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div>
                        <div class="notification-title" style="font-weight: 600; margin-bottom: 3px;">Meeting reminder</div>
                        <div class="notification-message" style="font-size: 13px; color: var(--text-secondary);">Team sync in 15 minutes</div>
                        <div class="notification-time" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">9:45 AM</div>
                    </div>
                </div>

                <div class="notification-item" style="display: flex; align-items: flex-start; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div class="notification-icon" style="background: rgba(76, 175, 80, 0.1); color: #4caf50; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <div class="notification-title" style="font-weight: 600; margin-bottom: 3px;">Email sent successfully</div>
                        <div class="notification-message" style="font-size: 13px; color: var(--text-secondary);">To: Michael Chen</div>
                        <div class="notification-time" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Yesterday, 4:22 PM</div>
                    </div>
                </div>

                <div class="notification-item" style="display: flex; align-items: flex-start; padding: 15px 0;">
                    <div class="notification-icon" style="background: rgba(33, 150, 243, 0.1); color: #2196f3; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div>
                        <div class="notification-title" style="font-weight: 600; margin-bottom: 3px;">System update available</div>
                        <div class="notification-message" style="font-size: 13px; color: var(--text-secondary);">Version 2.3.0 ready to install</div>
                        <div class="notification-time" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Jul 10</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- MODAL PERFIL -->
<div id="perfilIframeModal" class="iframe-modal-overlay" style="display: none;">
    <div class="iframe-modal-box">
      <button class="iframe-close-btn" onclick="cerrarPerfilIframe()">√ó</button>
      <iframe src="perfil-editor.html" frameborder="0" style="width:100%; height:85vh; border-radius: 1rem;"></iframe>
    </div>
  </div>
  

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {

// Initialize particles background (assuming particles.js is loaded)
// You might need to include the particles.js library in your HTML file.
if (typeof particlesJS !== 'undefined') {
    // Define particle configurations for dark and light themes
    const particlesDarkConfig = {
        "particles": { /* ... (your dark config) ... */
            "number": {"value": 80,"density": {"enable": true,"value_area": 800}},
            "color": {"value": "#6e45e2"},
            "shape": {"type": "circle"},
            "opacity": {"value": 0.3,"random": false,"anim": {"enable": false,"speed": 1,"opacity_min": 0.1,"sync": false}},
            "size": {"value": 3,"random": true,"anim": {"enable": false,"speed": 40,"size_min": 0.1,"sync": false}},
            "line_linked": {"enable": true,"distance": 150,"color": "#6e45e2","opacity": 0.2,"width": 1},
            "move": {"enable": true,"speed": 2,"direction": "none","random": false,"straight": false,"out_mode": "out","bounce": false,"attract": {"enable": false,"rotateX": 600,"rotateY": 1200}}
        },
        "interactivity": { /* ... (your interactivity config) ... */
            "detect_on": "canvas",
            "events": {"onhover": {"enable": true,"mode": "grab"},"onclick": {"enable": true,"mode": "push"},"resize": true},
            "modes": {"grab": {"distance": 140,"line_linked": {"opacity": 1}},"bubble": {"distance": 400,"size": 40,"duration": 2,"opacity": 8,"speed": 3},"repulse": {"distance": 200,"duration": 0.4},"push": {"particles_nb": 4},"remove": {"particles_nb": 2}}
        },
        "retina_detect": true
    };

    const particlesLightConfig = {
         "particles": { /* ... (your light config) ... */
            "number": {"value": 70, "density": {"enable": true,"value_area": 800}},
            "color": {"value": "#6e45e2"},
            "shape": {"type": "circle"},
            "opacity": {"value": 0.5, "random": true, "anim": {"enable": true, "speed": 1, "opacity_min": 0.2, "sync": false}},
            "size": {"value": 3, "random": true, "anim": {"enable": false}},
            "line_linked": {"enable": true, "distance": 150, "color": "#6e45e2", "opacity": 0.3, "width": 1},
            "move": {"enable": true, "speed": 1.8, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false, "attract": {"enable": false}}
        },
         "interactivity": { /* ... (your interactivity config) ... */
            "detect_on": "canvas",
            "events": {"onhover": {"enable": true,"mode": "grab"},"onclick": {"enable": true,"mode": "push"},"resize": true},
            "modes": {"grab": {"distance": 150,"line_linked": {"opacity": 0.8}},"bubble": {"distance": 400,"size": 40,"duration": 2,"opacity": 8,"speed": 3},"repulse": {"distance": 200,"duration": 0.4},"push": {"particles_nb": 4},"remove": {"particles_nb": 2}}
        },
        "retina_detect": true
    };


    const body = document.body;
    let currentParticlesConfig = body.classList.contains('light-theme') ? particlesLightConfig : particlesDarkConfig;
    particlesJS('particles-js', currentParticlesConfig);
} else {
    console.warn("particles.js library not found. Particles background will not be initialized.");
}


// --- DOM Elements ---
const sidebar = document.querySelector('.sidebar');
const mainContent = document.querySelector('.main-content');
const desktopToggleSidebarBtn = document.querySelector('.toggle-sidebar.desktop-only');
const mobileToggleSidebarBtn = document.querySelector('.toggle-sidebar.mobile-only');
const profile = document.querySelector('.user-profile');
const profileDropdown = document.querySelector('.profile-dropdown');
const emailListContainer = document.querySelector('.email-list-container');
const emailDetailContainer = document.querySelector('.email-detail-container');
const composeBtn = document.querySelector('.compose-btn');
const composeModal = document.querySelector('.compose-modal');
const composeCloseBtn = document.querySelector('.compose-close');
const composeToInput = document.getElementById('compose-to');
const composeCcInput = document.getElementById('compose-cc');
const composeSubjectInput = document.getElementById('compose-subject');
const composeBodyTextarea = document.getElementById('compose-body');
const composeSendBtn = document.querySelector('.compose-send');
const menuItems = document.querySelectorAll('.menu .menu-item');
const submenuItems = document.querySelectorAll('.submenu-item');
const currentFolderTitle = document.getElementById('current-folder-title');
const searchBar = document.querySelector('.search-bar');
const settingsModal = document.getElementById('settings-modal');
const notificationsModal = document.getElementById('notifications-modal');
const showSettingsBtn = document.getElementById('show-settings-btn');
const showNotificationsBtn = document.getElementById('show-notifications-btn');
const genericModalCloseBtns = document.querySelectorAll('.generic-modal-close');
const themeToggleSwitch = document.getElementById('theme-toggle-switch');
const body = document.body;
const emailList = document.querySelector(".email-list"); // Get the email list container
const backToListBtn = document.querySelector('.back-to-list'); // Mobile back button

// --- State ---
let currentPage = 1;
const emailsPerPage = 20; // Match server limit or make configurable
let currentBox = 'INBOX'; // Keep track of the currently viewed folder


// --- Theme Management ---
function toggleTheme() {
    body.classList.toggle('light-theme');
    localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');
    showNotification('Theme changed', body.classList.contains('light-theme') ? 'Light theme activated' : 'Dark theme activated', 'info');

    // Re-initialize particles with the correct config
    if (typeof particlesJS !== 'undefined') {
        let newParticlesConfig = body.classList.contains('light-theme') ? particlesLightConfig : particlesDarkConfig;
        // Destroy existing particles instance
        if (window.pJSDom && window.pJSDom.length > 0) {
             window.pJSDom[0].pJS.fn.vendors.destroypJS();
             window.pJSDom = []; // Clear the array
        }
         particlesJS('particles-js', newParticlesConfig);
    }
}

// Check for saved theme preference on load
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') {
    body.classList.add('light-theme');
    if (themeToggleSwitch) {
        themeToggleSwitch.querySelector('input').checked = true;
    }
}

// --- Sidebar Toggle Functionality ---
function toggleSidebar() {
    if (sidebar) {
        sidebar.classList.toggle('expanded');
        if (mainContent) {
            if (sidebar.classList.contains('expanded')) {
                mainContent.style.marginLeft = '280px';
            } else {
                mainContent.style.marginLeft = '90px';
            }
        }
    }
}

// Desktop toggle
if (desktopToggleSidebarBtn) {
    desktopToggleSidebarBtn.addEventListener('click', toggleSidebar);
}

// Mobile toggle
if (mobileToggleSidebarBtn) {
    mobileToggleSidebarBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (sidebar) {
            sidebar.classList.toggle('show-mobile');
        }
    });
}

// Close sidebar on mobile when clicking outside
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 992 && sidebar && sidebar.classList.contains('show-mobile')) {
        if (!sidebar.contains(e.target) && mobileToggleSidebarBtn && !mobileToggleSidebarBtn.contains(e.target)) {
            sidebar.classList.remove('show-mobile');
        }
    }
});

// --- Profile Dropdown Functionality ---
if (profile) {
    profile.addEventListener('click', (e) => {
        e.stopPropagation();
        if (profileDropdown) {
            profileDropdown.classList.toggle('show');
        }
    });
}

// Close profile dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (profileDropdown && profileDropdown.classList.contains('show') && profile && !profile.contains(e.target)) {
        profileDropdown.classList.remove('show');
    }
});

// Handle profile dropdown item clicks
if (profileDropdown) {
    profileDropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            if (profileDropdown) {
                profileDropdown.classList.remove('show');
            }

            if (action === 'settings') {
                if (settingsModal) showModal(settingsModal);
            } else if (action === 'theme-toggle') {
                toggleTheme();
            } else if (action === 'logout') {
                // Call server logout endpoint
                fetch("https://email-5byk.onrender.com/logout", {
                    method: "POST",
                     // Include credentials so the server knows which session to destroy
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Logged out', 'You have been successfully logged out', 'success');
                        // Redirect to login page after successful logout
                        setTimeout(() => {
                            window.location.href = "login.html";
                        }, 500);
                    } else {
                         showNotification('Logout Failed', data.error || 'Could not log out.', 'error');
                    }
                })
                .catch(err => {
                    console.error("Logout error:", err);
                    showNotification('Server Error', 'Error during logout.', 'error');
                     // Even if server error, attempt client-side cleanup/redirect
                     setTimeout(() => {
                         window.location.href = "login.html";
                     }, 500);
                });

            } else if (action === 'profile' || action === 'edit-profile') {
    const perfilModal = document.getElementById("perfilIframeModal");
    if (perfilModal) perfilModal.style.display = 'flex';
}

        });
    });
}


// --- Email Item Selection and Mobile View Switching (using event delegation) ---
if (emailList) {
    emailList.addEventListener('click', function(e) {
        const emailItem = e.target.closest('.email-item');
        if (!emailItem) return; // Not an email item

        if (e.target.closest('.email-actions')) {
            // Handle actions within the email item (like delete/archive buttons)
            const actionBtn = e.target.closest('.email-action-btn');
            if (actionBtn) {
                handleEmailItemAction(actionBtn, emailItem);
            }
            return;
        }

        // Handle email item selection
        document.querySelectorAll('.email-item').forEach(i => i.classList.remove('selected'));
        emailItem.classList.add('selected');

        const uid = emailItem.getAttribute("data-uid");
        if (uid) {
            mostrarCorreo(uid);
        } else {
            console.warn("Email item missing data-uid attribute.");
            // Fallback for simulated data if uid is missing (less relevant with real data)
            const sender = emailItem.querySelector('.email-sender').textContent;
            const subject = emailItem.querySelector('.email-subject').textContent;
            const time = emailItem.querySelector('.email-time').textContent;
            const preview = emailItem.querySelector('.email-preview').textContent;

            document.querySelector('.email-detail-subject').textContent = subject;
            document.querySelector('.sender-avatar').textContent = sender.charAt(0);
            document.querySelector('.sender-name').textContent = sender;
            // Simulate sender email if not available
            document.querySelector('.sender-email').textContent = `${sender.replace(/\s+/g, '.').toLowerCase()}@company.com`; // Placeholder
            document.querySelector('.email-detail-body').innerHTML = `<p>${preview}</p>`;

            if (window.innerWidth <= 992 && emailListContainer && emailDetailContainer) {
                emailListContainer.classList.remove('show-mobile');
                emailDetailContainer.classList.add('show-mobile');
            }
        }
    });
}


// --- Compose Modal Functionality ---
if (composeBtn) {
    composeBtn.addEventListener('click', () => {
        // Clear previous values
        if (composeToInput) composeToInput.value = '';
        if (composeCcInput) composeCcInput.value = '';
        if (composeSubjectInput) composeSubjectInput.value = '';
        if (composeBodyTextarea) composeBodyTextarea.value = '';
        if (composeModal) composeModal.classList.add('show');
    });
}

if (composeCloseBtn) {
    composeCloseBtn.addEventListener('click', () => {
        if (composeModal) composeModal.classList.remove('show');
    });
}

// Handle compose send button
if (composeSendBtn) {
    composeSendBtn.addEventListener('click', async () => {
        const to = composeToInput ? composeToInput.value : '';
        const subject = composeSubjectInput ? composeSubjectInput.value : '';
        const text = composeBodyTextarea ? composeBodyTextarea.value : '';
        // Add fields for HTML body and attachments if your UI supports them

        if (!to || !subject || !text) { // Basic validation
            showNotification('Campos incompletos', 'Llena To, Subject y Mensaje', 'warning');
            return;
        }

        try {
             const res = await fetch("https://email-5byk.onrender.com/send-email", {
                 method: "POST",
                 headers: { "Content-Type": "application/json" },
                 // Include credentials to maintain session
                 credentials: 'include',
                 body: JSON.stringify({ to, subject, text /*, html, attachments */ }) // Send data to server
             });

             // Check for unauthorized response (session expired/invalid)
             if (res.status === 401) {
                  showNotification('Session Expired', 'Please log in again.', 'error');
                  setTimeout(() => { window.location.href = "login.html"; }, 1000);
                  return;
             }

             const data = await res.json();

             if (res.ok && data.success) { // Check both HTTP status and server's success flag
                 showNotification('Correo enviado con √©xito', `A: ${to}`, 'success');
                 if (composeModal) composeModal.classList.remove('show');
                 cargarCorreos(currentBox, currentPage); // Reload the current folder
             } else {
                 showNotification('Error al enviar', data.error || 'No se pudo enviar el correo', 'error');
             }
        } catch (err) {
            console.error('SMTP Send Error:', err);
            showNotification('Error del servidor', 'Error sending email: ' + err.message, 'error');
        }
    });
}


// Handle compose attachment buttons (simulated)
if (composeModal) {
    composeModal.querySelectorAll('.attachment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            if (action === 'attach-file') {
                showNotification('File attached', 'Simulated file attachment', 'info');
                // TODO: Implement actual file input and handling
            } else if (action === 'insert-photo') {
                showNotification('Photo inserted', 'Simulated photo insertion', 'info');
                 // TODO: Implement actual image insertion
            } else if (action === 'insert-link') {
                showNotification('Link inserted', 'Simulated link insertion', 'info');
                 // TODO: Implement actual link insertion
            }
        });
    });
}


// --- Menu Item Selection ---
menuItems.forEach(item => {
    item.addEventListener('click', function() {
        if (this.classList.contains('has-submenu')) {
            this.classList.toggle('active');
            return;
        }

        menuItems.forEach(i => i.classList.remove('active'));
        submenuItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');

        const section = this.getAttribute('data-section');
        const folderName = this.querySelector('.menu-text') ? this.querySelector('.menu-text').textContent : this.textContent.trim();

        if (currentFolderTitle) {
            currentFolderTitle.textContent = folderName;
        }

        // Map section to server box name and load emails
        let boxToLoad = 'INBOX'; // Default
        if (section === 'inbox') boxToLoad = 'INBOX';
        else if (section === 'sent') boxToLoad = 'Sent'; // Assuming 'Sent' folder name
        else if (section === 'drafts') boxToLoad = 'Drafts'; // Assuming 'Drafts'
        else if (section === 'trash') boxToLoad = 'Trash'; // Assuming 'Trash'
        else if (section === 'spam') boxToLoad = 'Junk'; // Assuming 'Spam'
        else if (section === 'archive') boxToLoad = 'Archive';     // ‚úÖ NUEVO

        else if (section === 'starred') {
             showNotification('Loading starred', 'Showing your starred emails (simulated)', 'info');
             // TODO: Implement fetching starred emails from server
             return; // Don't call cargarCorreos for simulated section
        } else if (section === 'settings') {
            if (settingsModal) showModal(settingsModal);
            return; // Don't call cargarCorreos for modal section
        } else if (section === 'categories') {
             showNotification('Categories', 'Showing email categories (simulated)', 'info');
             // TODO: Implement category filtering/loading
             return; // Don't call cargarCorreos for simulated section
        }

        currentBox = boxToLoad; // Update current box state
        currentPage = 1; // Reset to first page when changing folders
        showNotification(`Loading ${folderName}`, 'Fetching emails...', 'info');
        cargarCorreos(currentBox, currentPage); // Load emails for the selected folder

        // Close sidebar on mobile after selection
        if (window.innerWidth <= 992 && sidebar && sidebar.classList.contains('show-mobile')) {
            sidebar.classList.remove('show-mobile');
        }
    });
});

// Submenu item selection
submenuItems.forEach(item => {
    item.addEventListener('click', function() {
        submenuItems.forEach(i => i.classList.remove('active'));
        menuItems.forEach(i => i.classList.remove('active')); // Deactivate main menu items
        this.classList.add('active');

        const section = this.getAttribute('data-section');
        const folderName = this.textContent.trim();

        if (currentFolderTitle) {
            currentFolderTitle.textContent = folderName;
        }

        // Map submenu section to server box name (or apply filter)
        let boxToLoad = 'INBOX'; // Default to INBOX or a specific folder for categories
        // TODO: Implement logic to load/filter emails based on category section
        if (section === 'work') {
             showNotification('Work emails', 'Showing work-related emails (simulated)', 'info');
             // cargarCorreos('Work'); // If 'Work' is a real folder
        } else if (section === 'personal') {
             showNotification('Personal emails', 'Showing personal emails (simulated)', 'info');
             // cargarCorreos('Personal'); // If 'Personal' is a real folder
        } else if (section === 'finance') {
             showNotification('Finance emails', 'Showing financial emails (simulated)', 'info');
             // cargarCorreos('Finance'); // If 'Finance' is a real folder
        } else if (section === 'social') {
             showNotification('Social emails', 'Showing social network emails (simulated)', 'info');
             // cargarCorreos('Social'); // If 'Social' is a real folder
        }

         // For now, just simulate notification and don't reload emails
        // If you map these to actual folders, uncomment cargarCorreos calls above
        // and update currentBox/currentPage.


        // On mobile, switch back to list view after selecting a folder
        if (window.innerWidth <= 992 && emailListContainer && emailDetailContainer) {
            emailListContainer.classList.add('show-mobile');
            emailDetailContainer.classList.remove('show-mobile');
        }
    });
});


// --- Topbar Action Buttons ---
if (showNotificationsBtn) {
    showNotificationsBtn.addEventListener('click', () => {
        if (notificationsModal) showModal(notificationsModal);
    });
}

if (showSettingsBtn) {
    showSettingsBtn.addEventListener('click', () => {
        if (settingsModal) showModal(settingsModal);
    });
}

// Close modals when clicking close button
genericModalCloseBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        const modal = this.closest('.generic-modal');
        if (modal) modal.classList.remove('show');
    });
});

// Close modals when clicking outside
document.querySelectorAll('.generic-modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('show');
        }
    });
});


// --- Email List Action Buttons ---
document.querySelectorAll('.list-action-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const action = this.getAttribute('data-action');
        if (action === 'refresh') {
            showNotification('Refreshing inbox', 'Checking for new emails...', 'info');
            // Call the function to load emails for the current folder
            // Use currentBox and reset to page 1 for a full refresh
            currentPage = 1; // Reset page on refresh
            cargarCorreos(currentBox, currentPage);

        } else if (action === 'more-list-actions') {
            showContextMenu(this, [
                { text: 'Mark all as read', icon: 'fas fa-envelope-open', action: 'mark-all-read' },
                { text: 'Select all', icon: 'fas fa-check-square', action: 'select-all' },
                { text: 'Empty trash', icon: 'fas fa-trash', action: 'empty-trash', danger: true }
            ]);
        }
    });
});

// --- Email Item Action Buttons (using event delegation on emailList) ---
function handleEmailItemAction(actionBtn, emailItem) {
    const action = actionBtn.getAttribute('data-action');
    const uid = emailItem.getAttribute('data-uid');
    const subject = emailItem.querySelector('.email-subject')?.textContent || 'Selected Email';

    if (!uid) {
        showNotification('Action Failed', 'Email ID missing.', 'error');
        return;
    }

    let endpoint = '';
    let successMessage = '';
    let errorMessage = '';
    let notificationType = 'info'; // Default
    let method = 'POST'; // Most actions are POST

    if (action === 'mark-read') {
        endpoint = "https://email-5byk.onrender.com/mark-read";
        successMessage = 'Email marked as read';
        errorMessage = 'Failed to mark as read';
        notificationType = 'success';
    } else if (action === 'mark-unread') {
        endpoint = "https://email-5byk.onrender.com/mark-unread";
        successMessage = 'Email marked as unread';
        errorMessage = 'Failed to mark as unread';
        notificationType = 'success';
    } else if (action === 'delete') {
        endpoint = "https://email-5byk.onrender.com/delete-email";
        successMessage = 'Email moved to trash';
        errorMessage = 'Failed to move to trash';
        notificationType = 'warning';
    } else if (action === 'archive') {
        endpoint = "https://email-5byk.onrender.com/archive-email";
        successMessage = 'Email archived';
        errorMessage = 'Failed to archive';
        notificationType = 'success';
    } else {
         console.warn(`Unknown action: ${action}`);
         return;
    }

    fetch(endpoint, {
        method: method,
        headers: { "Content-Type": "application/json" },
        // Include credentials to maintain session
        credentials: 'include',
        body: JSON.stringify({ uid, box: currentBox }) // Send uid and current box
    })
    .then(res => {
         if (res.status === 401) {
              showNotification('Session Expired', 'Please log in again.', 'error');
              setTimeout(() => { window.location.href = "login.html"; }, 1000);
              // Throw an error to skip further processing
              throw new Error('Unauthorized');
         }
         return res.json();
    })
    .then(data => {
        if (data.success) {
            showNotification(successMessage, subject, notificationType);

            // Client-side visual update based on action
            if (action === 'delete' || action === 'archive') {
                 emailItem.style.animation = 'fadeOut 0.3s forwards';
                 setTimeout(() => emailItem.remove(), 300);
                 // If the deleted/archived email was open in detail view, close it
                 if (document.querySelector('.email-item.selected')?.getAttribute('data-uid') === uid) {
                      if (emailListContainer && emailDetailContainer) {
                         emailListContainer.classList.add('show-mobile');
                         emailDetailContainer.classList.remove('show-mobile');
                     }
                 }
                 // Consider reloading the list to reflect changes, especially for delete/archive
                 // This might affect pagination state, so handle carefully
                 // cargarCorreos(currentBox, currentPage); // Optional: reload current page
            } else if (action === 'mark-read') {
                emailItem.classList.remove('unread');
                actionBtn.setAttribute('title', 'Mark as unread');
                actionBtn.setAttribute('data-action', 'mark-unread');
                actionBtn.innerHTML = '<i class="fas fa-envelope"></i>';
            } else if (action === 'mark-unread') {
                emailItem.classList.add('unread');
                actionBtn.setAttribute('title', 'Mark as read');
                actionBtn.setAttribute('data-action', 'mark-read');
                actionBtn.innerHTML = '<i class="fas fa-envelope-open"></i>';
            }

        } else {
            showNotification(errorMessage, data.error || 'An unknown error occurred.', 'error');
        }
    })
    .catch(err => {
        console.error(`${action} Email Error:`, err);
         if (err.message !== 'Unauthorized') { // Don't show second notification if it was an auth error
             showNotification('Server Error', `${errorMessage}: ${err.message}`, 'error');
         }
    });
}


// --- Email Detail Action Buttons ---
document.querySelectorAll('.detail-action-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const action = this.getAttribute('data-action');
        const subject = document.querySelector('.email-detail-subject')?.textContent || '(No Subject)';
        const selectedEmailItem = document.querySelector('.email-item.selected');
        const uid = selectedEmailItem ? selectedEmailItem.getAttribute('data-uid') : null;

        if (!uid && (action === 'delete' || action === 'archive')) {
             showNotification('Action Failed', 'No email selected.', 'error');
             return;
        }


        if (action === 'reply') {
             // Fetch email body to quote in reply
             fetch("https://email-5byk.onrender.com/email-body", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: 'include',
                body: JSON.stringify({ uid, box: currentBox })
             })
             .then(res => {
                 if (res.status === 401) {
                      showNotification('Session Expired', 'Please log in again.', 'error');
                      setTimeout(() => { window.location.href = "login.html"; }, 1000);
                      throw new Error('Unauthorized');
                 }
                 return res.json();
             })
             .then(data => {
                 const originalBody = data.text || data.html || '';
                 const senderName = document.querySelector('.sender-name')?.textContent || '';
                 const senderEmail = document.querySelector('.sender-email')?.textContent || ''; // Get sender email from detail view

                 showComposeModal('Re: ' + subject, `\n\n---------- Original Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Re: ', '')}\n\n${originalBody}`, true);
             })
             .catch(err => {
                 console.error('Fetch Email Body Error:', err);
                  if (err.message !== 'Unauthorized') {
                     showNotification('Error fetching email body', 'Could not prepare reply.', 'error');
                     showComposeModal('Re: ' + subject, '', true); // Open compose anyway
                  }
             });

        } else if (action === 'forward') {
             // Fetch email body to include in forward
             fetch("https://email-5byk.onrender.com/email-body", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: 'include',
                body: JSON.stringify({ uid, box: currentBox })
             })
             .then(res => {
                  if (res.status === 401) {
                       showNotification('Session Expired', 'Please log in again.', 'error');
                       setTimeout(() => { window.location.href = "login.html"; }, 1000);
                       throw new Error('Unauthorized');
                  }
                  return res.json();
             })
             .then(data => {
                 const originalBody = data.text || data.html || '';
                  const senderName = document.querySelector('.sender-name')?.textContent || '';
                  const senderEmail = document.querySelector('.sender-email')?.textContent || '';

                 showComposeModal('Fwd: ' + subject, `\n\n---------- Forwarded Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Fwd: ', '')}\n\n${originalBody}`, false);
             })
             .catch(err => {
                 console.error('Fetch Email Body Error:', err);
                  if (err.message !== 'Unauthorized') {
                     showNotification('Error fetching email body', 'Could not prepare forward.', 'error');
                     showComposeModal('Fwd: ' + subject, '', false); // Open compose anyway
                  }
             });

        } else if (action === 'delete') {
             handleEmailItemAction({ getAttribute: (attr) => attr === 'data-action' ? 'delete' : null }, selectedEmailItem);
        } else if (action === 'archive') {
             handleEmailItemAction({ getAttribute: (attr) => attr === 'data-action' ? 'archive' : null }, selectedEmailItem);
        }
    });
});

// --- Reply/Forward Buttons (using event delegation on emailDetailContainer) ---
if (emailDetailContainer) {
    emailDetailContainer.addEventListener('click', function(e) {
        const replyBtn = e.target.closest('.reply-btn');
        const forwardBtn = e.target.closest('.forward-btn');

        if (replyBtn || forwardBtn) {
            const action = replyBtn ? 'reply' : 'forward';
            const subject = document.querySelector('.email-detail-subject')?.textContent || '(No Subject)';
             const selectedEmailItem = document.querySelector('.email-item.selected');
             const uid = selectedEmailItem ? selectedEmailItem.getAttribute('data-uid') : null;

             if (!uid) {
                 showNotification('Action Failed', 'No email selected for reply/forward.', 'error');
                 return;
             }

            // Fetch email body to include in reply/forward
             fetch("https://email-5byk.onrender.com/email-body", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: 'include',
                body: JSON.stringify({ uid, box: currentBox })
             })
             .then(res => {
                  if (res.status === 401) {
                       showNotification('Session Expired', 'Please log in again.', 'error');
                       setTimeout(() => { window.location.href = "login.html"; }, 1000);
                       throw new Error('Unauthorized');
                  }
                  return res.json();
             })
             .then(data => {
                 const originalBody = data.text || data.html || '';
                  const senderName = document.querySelector('.sender-name')?.textContent || '';
                  const senderEmail = document.querySelector('.sender-email')?.textContent || '';

                 if (action === 'reply') {
                     showComposeModal('Re: ' + subject, `\n\n---------- Original Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Re: ', '')}\n\n${originalBody}`, true);
                 } else if (action === 'forward') {
                     showComposeModal('Fwd: ' + subject, `\n\n---------- Forwarded Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Fwd: ', '')}\n\n${originalBody}`, false);
                 }
             })
             .catch(err => {
                 console.error('Fetch Email Body Error:', err);
                  if (err.message !== 'Unauthorized') {
                     showNotification('Error fetching email body', `Could not prepare ${action}.`, 'error');
                     showComposeModal((action === 'reply' ? 'Re: ' : 'Fwd: ') + subject, '', action === 'reply'); // Open compose anyway
                  }
             });
        }
    });
}


// --- Attachment Items (simulated) ---
// Using event delegation on emailDetailContainer for attachments
if (emailDetailContainer) {
    emailDetailContainer.addEventListener('click', function(e) {
        const attachmentItem = e.target.closest('.attachment-item');
        if (attachmentItem) {
            const fileName = attachmentItem.textContent.trim();
            showNotification('Downloading attachment', fileName, 'info');
            // Simulate download with progress
            setTimeout(() => {
                showNotification('Download complete', fileName, 'success');
            }, 1500);
             // TODO: Implement actual attachment download via a server endpoint
        }
    });
}


// --- Search Functionality ---
if (searchBar) {
    searchBar.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        // Ideally, you'd send this searchTerm to a server endpoint
        // The server's /search-emails endpoint is ready for this.
        // For now, client-side filtering (less efficient for large lists):
        const emailItems = document.querySelectorAll('.email-item'); // Re-select items

        if (searchTerm.length > 1) { // Start searching after 2 characters
            emailItems.forEach(item => {
                const sender = item.querySelector('.email-sender')?.textContent.toLowerCase() || '';
                const subject = item.querySelector('.email-subject')?.textContent.toLowerCase() || '';
                const preview = item.querySelector('.email-preview')?.textContent.toLowerCase() || '';

                if (sender.includes(searchTerm) || subject.includes(searchTerm) || preview.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        } else {
            // Show all emails if search term is short or empty
            emailItems.forEach(item => {
                item.style.display = '';
            });
        }

         // TODO: Implement server-side search call here
         // Example:
         // if (searchTerm.length > 1) {
         //     searchEmails(searchTerm, currentBox); // Need to create searchEmails function
         // } else {
         //     cargarCorreos(currentBox, currentPage); // Reload current page if search cleared
         // }
    });
}


// --- Theme Toggle Switch ---
if (themeToggleSwitch) {
    themeToggleSwitch.addEventListener('change', function() {
        toggleTheme();
    });
}


// --- Helper Functions ---

// Function to show generic modals
function showModal(modal) {
    if (modal) {
        modal.classList.add('show');
    }
}

// Function to show notifications
function showNotification(title, message, type) {
    const notification = document.createElement('div');
    let icon = '';
    let bgColor = '';
    let textColor = '';

    switch (type) {
        case 'success':
            icon = '<i class="fas fa-check-circle"></i>';
            bgColor = 'rgba(76, 175, 80, 0.1)';
            textColor = 'var(--success-color)'; // Assuming --success-color CSS variable
            break;
        case 'error':
            icon = '<i class="fas fa-exclamation-circle"></i>';
            bgColor = 'rgba(244, 67, 54, 0.1)';
            textColor = 'var(--error-color)'; // Assuming --error-color CSS variable
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle"></i>';
            bgColor = 'rgba(255, 152, 0, 0.1)';
            textColor = 'var(--warning-color)'; // Assuming --warning-color CSS variable
            break;
        case 'info':
            icon = '<i class="fas fa-info-circle"></i>';
            bgColor = 'rgba(33, 150, 243, 0.1)';
            textColor = 'var(--info-color)'; // Assuming --info-color CSS variable
            break;
        default:
            icon = '<i class="fas fa-bell"></i>';
            bgColor = 'rgba(110, 69, 226, 0.1)';
            textColor = 'var(--accent-color)'; // Using accent color for default
    }

    notification.innerHTML = `
        <div style="display: flex; align-items: center;">
            <div style="width: 40px; height: 40px; background: ${bgColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: ${textColor};">
                ${icon}
            </div>
            <div>
                <div style="font-weight: 600; margin-bottom: 3px; color: var(--text-primary);">${title}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${message}</div>
            </div>
        </div>
    `;
    notification.style.position = 'fixed';
    notification.style.bottom = '30px';
    notification.style.left = '30px';
    notification.style.backgroundColor = 'var(--card-bg)';
    notification.style.color = 'white'; // Base color, overridden by text-primary/secondary
    notification.style.padding = '20px';
    notification.style.borderRadius = '12px';
    notification.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
    notification.style.zIndex = '1000';
    notification.style.animation = 'slideIn 0.5s ease-out forwards';
    notification.style.border = 'var(--glass-border)'; // Assuming --glass-border CSS variable
    notification.style.backdropFilter = 'blur(5px)';
    notification.style.maxWidth = '300px';
    notification.style.transform = 'translateY(20px)';
    notification.style.opacity = '0';
    // Ensure notification container exists or append to body
    let notificationContainer = document.getElementById('notification-container');
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        notificationContainer.style.position = 'fixed';
        notificationContainer.style.bottom = '20px';
        notificationContainer.style.left = '20px';
        notificationContainer.style.zIndex = '1000';
        notificationContainer.style.display = 'flex';
        notificationContainer.style.flexDirection = 'column-reverse'; // Stack new notifications on top
        notificationContainer.style.gap = '10px';
        document.body.appendChild(notificationContainer);
    }
    notificationContainer.appendChild(notification);


    setTimeout(() => {
        notification.style.transform = 'translateY(0)';
        notification.style.opacity = '1';
    }, 100);

    // Auto-remove notification
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s forwards'; // Assuming fadeOut animation
        setTimeout(() => notification.remove(), 500);
    }, 5000); // Notification duration
}

// Function to show the compose modal with pre-filled data
function showComposeModal(subject = '', body = '', isReply = false) {
    if (composeSubjectInput) composeSubjectInput.value = subject;
    if (composeBodyTextarea) composeBodyTextarea.value = body;

    if (isReply) {
        const senderEmail = document.querySelector('.sender-email')?.textContent || '';
        if (composeToInput) composeToInput.value = senderEmail;
        // Append original message to body
        const originalBody = document.querySelector('.email-detail-body')?.textContent || ''; // Use textContent for reply quoting
         const senderName = document.querySelector('.sender-name')?.textContent || '';
        if (composeBodyTextarea) {
             composeBodyTextarea.value = `\n\n---------- Original Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Re: ', '')}\n\n${originalBody}`;
        }
    } else {
         if (composeToInput) composeToInput.value = ''; // Clear 'To' for new compose/forward
    }

    if (composeModal) composeModal.classList.add('show');
}

// Function to show a custom context menu
function showContextMenu(element, items) {
    // Remove any existing context menu
    const existingMenu = document.querySelector('.context-menu');
    if (existingMenu) existingMenu.remove();

    // Create new context menu
    const contextMenu = document.createElement('div');
    contextMenu.className = 'context-menu';

    // Position the menu near the element
    const rect = element.getBoundingClientRect();
    contextMenu.style.position = 'fixed';
    contextMenu.style.left = `${rect.left}px`;
    contextMenu.style.top = `${rect.bottom + 5}px`;
    contextMenu.style.backgroundColor = 'var(--card-bg)';
    contextMenu.style.borderRadius = '8px';
    contextMenu.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
    contextMenu.style.zIndex = '1000';
    contextMenu.style.border = 'var(--glass-border)';
    contextMenu.style.overflow = 'hidden';
    contextMenu.style.animation = 'fadeIn 0.2s ease-out';


    // Add items to the menu
    items.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = `context-item ${item.danger ? 'delete' : ''}`;
        menuItem.innerHTML = `<i class="${item.icon}"></i> ${item.text}`;
        menuItem.style.padding = '12px 20px';
        menuItem.style.display = 'flex';
        menuItem.style.alignItems = 'center';
        menuItem.style.cursor = 'pointer';
        menuItem.style.transition = 'all 0.2s';
         menuItem.style.color = item.danger ? 'var(--danger-color)' : 'var(--text-primary)';


        menuItem.querySelector('i').style.marginRight = '10px';
        menuItem.querySelector('i').style.width = '20px';


        menuItem.addEventListener('mouseenter', () => {
            menuItem.style.background = 'rgba(255,255,255,0.05)';
            menuItem.style.paddingLeft = '25px';
        });

        menuItem.addEventListener('mouseleave', () => {
            menuItem.style.background = 'transparent';
            menuItem.style.paddingLeft = '20px';
        });

        menuItem.addEventListener('click', () => {
            // Handle context menu item actions
            if (item.action === 'mark-all-read') {
                // TODO: Implement server endpoint for mark all as read
                showNotification('Marking all as read', '(Simulated action)', 'info');
                // Simulate marking all as read
                document.querySelectorAll('.email-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const readToggleBtn = item.querySelector('.email-action-btn[data-action="mark-unread"]');
                    if(readToggleBtn) {
                        readToggleBtn.setAttribute('title', 'Mark as unread');
                        readToggleBtn.setAttribute('data-action', 'mark-unread');
                        readToggleBtn.innerHTML = '<i class="fas fa-envelope"></i>';
                    }
                });
                showNotification('All emails marked as read', '', 'success');
            } else if (item.action === 'select-all') {
                document.querySelectorAll('.email-item').forEach(item => {
                    item.classList.add('selected');
                });
                showNotification('All emails selected', '', 'info');
            } else if (item.action === 'empty-trash') {
                // TODO: Implement server endpoint for empty trash
                showNotification('Emptying trash', '(Simulated action)', 'warning');
                 // Simulate removing items from the trash view if currently in trash folder
                if (currentBox.toLowerCase() === 'trash') {
                    if (emailList) emailList.innerHTML = '';
                }
            }
            contextMenu.remove();
            document.removeEventListener('click', closeMenu); // Remove listener after action
        });
        contextMenu.appendChild(menuItem);
    });

    document.body.appendChild(contextMenu);

    // Close menu when clicking outside
    const closeMenu = (e) => {
        if (!contextMenu.contains(e.target) && e.target !== element) {
            contextMenu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };

    // Add the click listener after a small delay to avoid immediate closing
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
    }, 100);
}


// Wave effect on buttons
const waveButtons = document.querySelectorAll('.wave-btn');
waveButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
        const wave = document.createElement('span');
        wave.className = 'wave';

        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        wave.style.left = x + 'px';
        wave.style.top = y + 'px';

        this.appendChild(wave);

        setTimeout(() => {
            wave.remove();
        }, 600); // Match CSS animation duration
    });
});

// Context menu for emails (right click) - Using event delegation
if (emailList) {
    emailList.addEventListener('contextmenu', (e) => {
        const emailItem = e.target.closest('.email-item');
        if (!emailItem) return; // Only show menu for email items

        e.preventDefault(); // Prevent default browser context menu

        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) existingMenu.remove();

        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu';
        contextMenu.style.position = 'fixed';
        contextMenu.style.left = `${e.clientX}px`;
        contextMenu.style.top = `${e.clientY}px`;
        contextMenu.style.backgroundColor = 'var(--card-bg)';
        contextMenu.style.borderRadius = '8px';
        contextMenu.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
        contextMenu.style.zIndex = '1000';
        contextMenu.style.border = 'var(--glass-border)';
        contextMenu.style.overflow = 'hidden';
        contextMenu.style.animation = 'fadeIn 0.2s ease-out';

        contextMenu.innerHTML = `
            <div class="context-item" data-action="reply">
                <i class="fas fa-reply"></i> Reply
            </div>
            <div class="context-item" data-action="forward">
                <i class="fas fa-share"></i> Forward
            </div>
            <div class="context-item" data-action="archive">
                <i class="fas fa-archive"></i> Archive
            </div>
            <div class="context-item delete" data-action="delete">
                <i class="fas fa-trash"></i> Delete
            </div>
        `;

        document.body.appendChild(contextMenu);

        // Close menu when clicking outside
        const closeMenu = (clickEvent) => {
            if (!contextMenu.contains(clickEvent.target)) {
                contextMenu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };

        setTimeout(() => {
            document.addEventListener('click', closeMenu);
        }, 100);

        // Add event listeners to context menu items
        contextMenu.querySelectorAll('.context-item').forEach(item => {
            item.style.padding = '12px 20px';
            item.style.display = 'flex';
            item.style.alignItems = 'center';
            item.style.cursor = 'pointer';
            item.style.transition = 'all 0.2s';
             item.style.color = item.classList.contains('delete') ? 'var(--danger-color)' : 'var(--text-primary)';


            item.querySelector('i').style.marginRight = '10px';
            item.querySelector('i').style.width = '20px';

            item.addEventListener('mouseenter', () => {
                item.style.background = 'rgba(255,255,255,0.05)';
                item.style.paddingLeft = '25px';
            });

            item.addEventListener('mouseleave', () => {
                item.style.background = 'transparent';
                item.style.paddingLeft = '20px';
            });

            item.addEventListener('click', () => {
                const action = item.getAttribute('data-action');
                const uid = emailItem.getAttribute('data-uid');
                const subject = emailItem.querySelector('.email-subject')?.textContent || '(No Subject)';

                if (!uid) {
                     showNotification('Action Failed', 'Email ID missing.', 'error');
                     contextMenu.remove();
                     document.removeEventListener('click', closeMenu);
                     return;
                }

                if (action === 'reply') {
                     // Fetch email body to quote in reply
                     fetch("https://email-5byk.onrender.com/email-body", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        credentials: 'include',
                        body: JSON.stringify({ uid, box: currentBox })
                     })
                     .then(res => {
                         if (res.status === 401) {
                              showNotification('Session Expired', 'Please log in again.', 'error');
                              setTimeout(() => { window.location.href = "login.html"; }, 1000);
                              throw new Error('Unauthorized');
                         }
                         return res.json();
                     })
                     .then(data => {
                         const originalBody = data.text || data.html || '';
                         const senderName = emailItem.querySelector('.email-sender')?.textContent.split('<')[0].trim() || '';
                         const senderEmail = emailItem.querySelector('.email-sender')?.textContent.includes('@') ? emailItem.querySelector('.email-sender').textContent.match(/<(.*?)>/)?.[1] || '' : ''; // Extract email from sender string

                         showComposeModal('Re: ' + subject, `\n\n---------- Original Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Re: ', '')}\n\n${originalBody}`, true);
                     })
                     .catch(err => {
                         console.error('Fetch Email Body Error:', err);
                          if (err.message !== 'Unauthorized') {
                             showNotification('Error fetching email body', 'Could not prepare reply.', 'error');
                             showComposeModal('Re: ' + subject, '', true); // Open compose anyway
                          }
                     });

                } else if (action === 'forward') {
                     // Fetch email body to include in forward
                     fetch("https://email-5byk.onrender.com/email-body", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        credentials: 'include',
                        body: JSON.stringify({ uid, box: currentBox })
                     })
                     .then(res => {
                          if (res.status === 401) {
                               showNotification('Session Expired', 'Please log in again.', 'error');
                               setTimeout(() => { window.location.href = "login.html"; }, 1000);
                               throw new Error('Unauthorized');
                          }
                          return res.json();
                     })
                     .then(data => {
                         const originalBody = data.text || data.html || '';
                          const senderName = emailItem.querySelector('.email-sender')?.textContent.split('<')[0].trim() || '';
                          const senderEmail = emailItem.querySelector('.email-sender')?.textContent.includes('@') ? emailItem.querySelector('.email-sender').textContent.match(/<(.*?)>/)?.[1] || '' : '';

                         showComposeModal('Fwd: ' + subject, `\n\n---------- Forwarded Message ----------\nFrom: ${senderName} <${senderEmail}>\nSubject: ${subject.replace('Fwd: ', '')}\n\n${originalBody}`, false);
                     })
                     .catch(err => {
                         console.error('Fetch Email Body Error:', err);
                          if (err.message !== 'Unauthorized') {
                             showNotification('Error fetching email body', 'Could not prepare forward.', 'error');
                             showComposeModal('Fwd: ' + subject, '', false); // Open compose anyway
                          }
                     });

                } else if (action === 'archive') {
                    handleEmailItemAction({ getAttribute: (attr) => attr === 'data-action' ? 'archive' : null }, emailItem);
                } else if (action === 'delete') {
                    handleEmailItemAction({ getAttribute: (attr) => attr === 'data-action' ? 'delete' : null }, emailItem);
                }
                contextMenu.remove();
                document.removeEventListener('click', closeMenu);
            });
        });
    });
}


// Double click to open email in modal (simulated) - Using event delegation
if (emailList) {
    emailList.addEventListener('dblclick', (e) => {
        const emailItem = e.target.closest('.email-item');
        if (!emailItem) return; // Only open modal for email items

        const uid = emailItem.getAttribute('data-uid');
        if (!uid) {
             console.warn("Double-clicked email item missing data-uid.");
             showNotification('Error', 'Email details not available.', 'error');
             return;
        }

        // Fetch the full email body and display in a modal
         fetch("https://email-5byk.onrender.com/email-body", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: 'include',
            body: JSON.stringify({ uid, box: currentBox })
         })
         .then(res => {
              if (res.status === 401) {
                   showNotification('Session Expired', 'Please log in again.', 'error');
                   setTimeout(() => { window.location.href = "login.html"; }, 1000);
                   throw new Error('Unauthorized');
              }
              return res.json();
         })
         .then(data => {
             const emailContentHTML = data.html || `<pre>${data.text || "(Sin contenido)"}</pre>`;
             const subject = emailItem.querySelector('.email-subject')?.textContent || '(No Subject)';
             const sender = emailItem.querySelector('.email-sender')?.textContent || '(Desconocido)';
             const time = emailItem.querySelector('.email-time')?.textContent || '';

             const modal = document.createElement('div');
             modal.style.position = 'fixed';
             modal.style.top = '0';
             modal.style.left = '0';
             modal.style.width = '100%';
             modal.style.height = '100%';
             modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
             modal.style.zIndex = '2000';
             modal.style.display = 'flex';
             modal.style.alignItems = 'center';
             modal.style.justifyContent = 'center';
             modal.style.animation = 'fadeIn 0.3s';

             const content = document.createElement('div');
             content.style.backgroundColor = 'var(--card-bg)';
             content.style.borderRadius = '15px';
             content.style.padding = '30px';
             content.style.maxWidth = '800px';
             content.style.width = '90%';
             content.style.maxHeight = '90vh';
             content.style.overflowY = 'auto';
             content.style.boxShadow = '0 15px 50px rgba(0,0,0,0.5)';
             content.style.position = 'relative';

             const closeBtn = document.createElement('button');
             closeBtn.innerHTML = '<i class="fas fa-times"></i>';
             closeBtn.style.position = 'absolute';
             closeBtn.style.top = '15px';
             closeBtn.style.right = '15px';
             closeBtn.style.background = 'none';
             closeBtn.style.border = 'none';
             closeBtn.style.color = 'var(--text-secondary)';
             closeBtn.style.fontSize = '20px';
             closeBtn.style.cursor = 'pointer';
             closeBtn.style.width = '40px';
             closeBtn.style.height = '40px';
             closeBtn.style.borderRadius = '50%';
             closeBtn.style.display = 'flex';
             closeBtn.style.alignItems = 'center';
             closeBtn.style.justifyContent = 'center';
             closeBtn.style.transition = 'all 0.2s';

             closeBtn.addEventListener('mouseenter', () => {
                 closeBtn.style.background = 'rgba(255,255,255,0.1)';
                 closeBtn.style.color = 'var(--text-primary)';
             });

             closeBtn.addEventListener('mouseleave', () => {
                 closeBtn.style.background = 'none';
                 closeBtn.style.color = 'var(--text-secondary)';
             });

             closeBtn.addEventListener('click', () => {
                 modal.style.animation = 'fadeIn 0.3s reverse';
                 setTimeout(() => modal.remove(), 300);
             });

             const modalEmailContent = `
                 <h2 style="margin-bottom: 20px; color: var(--accent-color);">${subject}</h2>
                 <div style="display: flex; align-items: center; margin-bottom: 20px;">
                     <div style="width: 50px; height: 50px; background: var(--secondary-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px;">
                         ${sender.charAt(0)}
                     </div>
                     <div>
                         <div style="font-weight: 600; color: var(--text-primary);">${sender}</div>
                         <div style="font-size: 13px; color: var(--text-secondary);">${time}</div>
                     </div>
                 </div>
                 <div style="line-height: 1.8; color: var(--text-primary);">
                     ${emailContentHTML}
                 </div>
             `;

             content.innerHTML = modalEmailContent;
             content.appendChild(closeBtn);
             modal.appendChild(content);
             document.body.appendChild(modal);

             modal.addEventListener('click', (e) => {
                 if (e.target === modal) {
                     modal.style.animation = 'fadeIn 0.3s reverse';
                     setTimeout(() => modal.remove(), 300);
                 }
             });
         })
         .catch(err => {
             console.error('Fetch Email Body Error (Modal):', err);
              if (err.message !== 'Unauthorized') {
                 showNotification('Error fetching email', 'Could not load email content.', 'error');
              }
         });
    });
}


// Function to load emails from the server with pagination
async function cargarCorreos(box = 'INBOX', page = 1, limit = emailsPerPage) {
    const lista = document.querySelector(".email-list");
    if (!lista) {
        console.warn("‚ö†Ô∏è email-list container not available yet");
        return;
    }

    // Clear previous emails and show loading indicator
    lista.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading emails...</div>';

    try {
        const res = await fetch("https://email-5byk.onrender.com/emails", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // Include credentials (session cookie) for authentication
            credentials: 'include',
            body: JSON.stringify({ box, page, limit }) // Send box, page, and limit
        });

        // Check for unauthorized response (session expired/invalid)
        if (res.status === 401) {
             showNotification('Session Expired', 'Please log in again.', 'error');
             // Redirect to login page
             setTimeout(() => { window.location.href = "login.html"; }, 1000);
             // Clear the list and stop processing
             lista.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Session expired. Redirecting to login...</div>';
             return; // Stop execution
        }

        const data = await res.json(); // Server now returns { emails: [...], total: ... }

        if (!res.ok) {
             // Handle other server-side errors
             throw new Error(data.error || `Server returned status ${res.status}`);
        }

        // Check if the response contains the expected 'emails' array
        if (!data || !Array.isArray(data.emails)) {
            throw new Error("Invalid response format from server: Expected an object with an 'emails' array.");
        }

        const correos = data.emails; // Get the emails array from the response object
        const totalEmails = data.total; // Get the total count

        lista.innerHTML = ""; // Clear previous emails

        if (correos.length === 0) {
             lista.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No emails in this folder.</div>';
        } else {
            correos.forEach(correo => {
                const item = document.createElement("div");
                // Use 'seen' flag from server if available, otherwise default
                item.className = `email-item ${correo.seen ? '' : 'unread'}`;
                item.setAttribute("data-uid", correo.uid); // ‚úÖ necessary to identify email

                // Format date and time
                const emailDate = new Date(correo.date);
                const now = new Date();
                let timeDisplay = '';
                if (emailDate.toDateString() === now.toDateString()) {
                    timeDisplay = emailDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    timeDisplay = emailDate.toLocaleDateString();
                }

                item.innerHTML = `
                    <div class="email-item-header">
                        <div class="email-sender">${correo.from || '(Desconocido)'}</div>
                        <div class="email-time">${timeDisplay}</div>
                    </div>
                    <div class="email-subject">${correo.subject || "(Sin asunto)"}</div>
                    <div class="email-preview">${correo.preview || ""}</div>
                     <div class="email-actions">
                         <button class="email-action-btn" data-action="archive" title="Archive"><i class="fas fa-archive"></i></button>
                         <button class="email-action-btn" data-action="delete" title="Delete"><i class="fas fa-trash"></i></button>
                         <button class="email-action-btn" data-action="${correo.seen ? 'mark-unread' : 'mark-read'}" title="${correo.seen ? 'Mark as unread' : 'Mark as read'}">
                             <i class="fas ${correo.seen ? 'fa-envelope' : 'fa-envelope-open'}"></i>
                         </button>
                     </div>
                `;

                // Event listeners for actions are handled by delegation on emailList

                lista.appendChild(item);
            });

             // TODO: Implement pagination UI controls (Previous/Next buttons, page numbers)
             // Use totalEmails to calculate total pages and update UI
             const totalPages = Math.ceil(totalEmails / limit);
             console.log(`Loaded page ${page} of ${totalPages} (${totalEmails} total emails)`);
             // Example: Update a pagination info element
             // document.getElementById('pagination-info').textContent = `Page ${page} of ${totalPages} (${totalEmails} emails)`;
        }

    } catch (err) {
        console.error("‚ùå Error cargando correos:", err);
        lista.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--error-color);">Error loading emails: ${err.message}</div>`;
        showNotification('Error loading emails', err.message, 'error');
    }
}

// Function to display the full email body
async function mostrarCorreo(uid) {
    const detalle = document.querySelector(".email-detail-body");
    const subjectElem = document.querySelector('.email-detail-subject');
    const senderNameElem = document.querySelector('.sender-name');
    const senderEmailElem = document.querySelector('.sender-email');
    const senderAvatarElem = document.querySelector('.sender-avatar');


    if (!detalle || !subjectElem || !senderNameElem || !senderEmailElem || !senderAvatarElem) {
         console.warn("‚ö†Ô∏è Email detail elements not found.");
         showNotification('Error', 'Email detail panel not ready.', 'error');
         return;
    }

    // Show loading indicator in detail panel
    detalle.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading email content...</div>';
    subjectElem.textContent = 'Loading...';
    senderNameElem.textContent = '';
    senderEmailElem.textContent = '';
    senderAvatarElem.textContent = '';


    try {
        // Get the email item from the list to populate header info immediately
        const item = document.querySelector(`.email-item[data-uid="${uid}"]`);
        if (item) {
             const from = item.querySelector(".email-sender")?.textContent || "(Desconocido)";
             const subject = item.querySelector(".email-subject")?.textContent || "(Sin asunto)";
             const time = item.querySelector(".email-time")?.textContent || "";

             subjectElem.textContent = subject;
             senderNameElem.textContent = from.split('<')[0].trim();
             // Attempt to extract email from "Name <email>" format, fallback to placeholder
             senderEmailElem.textContent = from.includes("@") ? from.match(/<(.*?)>/)?.[1] || from : '(Email desconocido)';
             senderAvatarElem.textContent = from.charAt(0);

            // Mark the email as read visually and update button
            item.classList.remove('unread');
             const readToggleBtn = item.querySelector('.email-action-btn[data-action="mark-unread"]');
             if(readToggleBtn) {
                 readToggleBtn.setAttribute('title', 'Mark as unread');
                 readToggleBtn.setAttribute('data-action', 'mark-unread');
                 readToggleBtn.innerHTML = '<i class="fas fa-envelope"></i>';
             }
             // The server endpoint /email-body now automatically marks as seen
             // So no separate fetch call is needed here just for marking.

        } else {
             // If item not found in current list (e.g., loaded directly via UID),
             // you might need a different server endpoint to get header info by UID.
             subjectElem.textContent = '(Loading...)';
             senderNameElem.textContent = '(Loading...)';
             senderEmailElem.textContent = '(Loading...)';
             senderAvatarElem.textContent = '?';
        }


        // Fetch email body
        const res = await fetch("https://email-5byk.onrender.com/email-body", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: 'include', // Include session cookie
            body: JSON.stringify({ uid, box: currentBox }) // Send uid and current box
        });

         // Check for unauthorized response (session expired/invalid)
        if (res.status === 401) {
             showNotification('Session Expired', 'Please log in again.', 'error');
             setTimeout(() => { window.location.href = "login.html"; }, 1000);
             // Clear the detail view and stop processing
             detalle.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Session expired. Redirecting to login...</div>';
             subjectElem.textContent = '';
             senderNameElem.textContent = '';
             senderEmailElem.textContent = '';
             senderAvatarElem.textContent = '';
             return; // Stop execution
        }


        const data = await res.json();

        if (!res.ok) {
             throw new Error(data.error || `Server returned status ${res.status}`);
        }

        const contenido = data.html || `<pre>${data.text || "(Sin contenido)"}</pre>`;

        // Display the content
        detalle.innerHTML = contenido;

        // Activate detail panel view
        const contenedor = document.querySelector(".email-detail-container");
        if (contenedor) {
             contenedor.style.display = "flex"; // Assuming it's display: none by default
        }


        // For mobile, switch views
        if (window.innerWidth <= 992 && emailListContainer && emailDetailContainer) {
            emailListContainer.classList.remove('show-mobile');
            emailDetailContainer.classList.add('show-mobile');
        }

    } catch (err) {
        console.error("‚ùå Error mostrando correo:", err);
         if (err.message !== 'Unauthorized') { // Don't show second notification if it was an auth error
            detalle.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--error-color);">Error loading email content: ${err.message}</div>`;
            subjectElem.textContent = '(Error)';
            senderNameElem.textContent = '';
            senderEmailElem.textContent = '';
            senderAvatarElem.textContent = '!';
            showNotification('Error showing email', err.message, 'error');
         }
    }
}

// Add event listener for the back button in email detail view (for mobile)
if (backToListBtn && emailListContainer && emailDetailContainer) {
    backToListBtn.addEventListener('click', () => {
        if (window.innerWidth <= 992) {
            emailListContainer.classList.add('show-mobile');
            emailDetailContainer.classList.remove('show-mobile');
        }
    });
}


// --- Pagination Controls (Placeholder) ---
// You will need HTML buttons/elements for pagination
// Example:
// const prevPageBtn = document.getElementById('prev-page-btn');
// const nextPageBtn = document.getElementById('next-page-btn');

// if (prevPageBtn) {
//      prevPageBtn.addEventListener('click', () => {
//          if (currentPage > 1) {
//              currentPage--;
//              cargarCorreos(currentBox, currentPage);
//          }
//      });
// }

// if (nextPageBtn) {
//      nextPageBtn.addEventListener('click', () => {
//          // You'll need total emails or total pages info to know if there's a next page
//          // For now, just increment and hope for the best or check response
//          currentPage++;
//          cargarCorreos(currentBox, currentPage);
//      });
// }


// --- Initial Load ---
// Load emails when the window is fully loaded
window.addEventListener("load", () => {
    // Check if a session is active by attempting to load emails
    // If the server returns 401, the fetch error handler will redirect to login.
    cargarCorreos(currentBox, currentPage); // Load INBOX (default) page 1 initially
});


// Add CSS for animations and context menu if not already in your CSS file
const style = document.createElement('style');
style.innerHTML = `
@keyframes fadeIn {
from { opacity: 0; transform: scale(0.95); }
to { opacity: 1; transform: scale(1); }
}

@keyframes fadeOut {
from { opacity: 1; transform: translateX(0); }
to { opacity: 0; transform: translateX(-20px); } /* Slide out to the left */
}

@keyframes slideIn {
from { transform: translateY(20px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.context-menu {
/* Styles defined inline in showContextMenu function */
/* Add any additional styles here */
}

.context-item:hover {
/* Styles defined inline in showContextMenu function */
}

.context-item.delete {
color: var(--danger-color); /* Example: Red color for delete action */
}

.wave-btn {
position: relative;
overflow: hidden;
transform: translate3d(0, 0, 0); /* Hardware acceleration */
}

.wave {
display: block;
position: absolute;
background: rgba(255, 255, 255, 0.3); /* White wave */
border-radius: 100%;
transform: scale(0);
animation: wave 0.6s linear;
pointer-events: none;
}

@keyframes wave {
to { transform: scale(2.5); opacity: 0; }
}

/* Basic styles for modals if not already present */
.generic-modal {
display: none; /* Hidden by default */
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.4);
align-items: center;
justify-content: center;
}

.generic-modal.show {
display: flex; /* Show when 'show' class is added */
}

.generic-modal-content {
background-color: var(--card-bg);
margin: auto;
padding: 20px;
border-radius: 10px;
max-width: 500px;
width: 90%;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
position: relative;
}

.generic-modal-close {
position: absolute;
top: 10px;
right: 10px;
font-size: 24px;
font-weight: bold;
color: var(--text-secondary);
cursor: pointer;
background: none;
border: none;
}

/* Styles for mobile view switching */
@media (max-width: 992px) {
.email-list-container {
    display: none; /* Hide list by default on mobile */
}
.email-list-container.show-mobile {
    display: flex; /* Show list when active */
    width: 100%; /* Take full width */
}
.email-detail-container {
    display: none; /* Hide detail by default on mobile */
}
.email-detail-container.show-mobile {
    display: flex; /* Show detail when active */
    width: 100%; /* Take full width */
}
 .sidebar {
    transform: translateX(-100%); /* Hide sidebar off-screen */
    transition: transform 0.3s ease-in-out;
 }
 .sidebar.show-mobile {
    transform: translateX(0); /* Show sidebar */
 }
 .main-content {
    margin-left: 0 !important; /* Remove margin on mobile */
 }
 .toggle-sidebar.desktop-only {
    display: none;
 }
 .toggle-sidebar.mobile-only {
    display: block; /* Show mobile toggle */
 }
 .back-to-list {
     display: block !important; /* Show back button on mobile */
 }
}

/* Ensure back button is hidden on desktop */
@media (min-width: 993px) {
.back-to-list {
    display: none !important;
}
}

/* Basic styles for notification colors */
:root {
--success-color: #4CAF50; /* Green */
--error-color: #F44336;   /* Red */
--warning-color: #FF9800;  /* Orange */
--info-color: #2196F3;    /* Blue */
}

`;
document.head.appendChild(style);


}); // End DOMContentLoaded

// Note: The functions showModal, showNotification, showComposeModal, showContextMenu
// are defined inside the DOMContentLoaded listener in the code above.
// They are not globally accessible unless explicitly attached to window.




function cerrarPerfilIframe() {
  const modal = document.getElementById("perfilIframeModal");
  if (modal) {
    modal.style.display = 'none';
    // Reinicia el iframe para que siempre cargue limpio
    const iframe = modal.querySelector('iframe');
    if (iframe) {
      iframe.src = iframe.src;
    }
  }
}

    </script>
</body>
</html>